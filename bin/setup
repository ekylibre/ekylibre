#!/bin/bash

# This script is a way to set up or update your development environment automatically.
# This script is idempotent, so that you can run it at any time and get an expectable outcome.
# Add necessary setup steps to this file.

# Exit if any subcommand fails
set -e

SKIP_DEMO=false

# Detect if arguments includes option --no-demo to skip demo first run
if [[ " $@ " =~ " --skip-demo " ]]; then
  SKIP_DEMO=true
fi

cat bin/install/alt.txt

# Install OS-specific packages for MacOS, Debian, and Ubuntu
if [[ "$OSTYPE" == "darwin"* ]]; then
  # Mac OSX
  sh bin/install/./macos
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
  # Detecting OS Version
  OS_VERSION=$(lsb_release -ds)
  if [[ "$OS_VERSION" == "Ubuntu 20.04"* ]]; then
    sh bin/install/./ubuntu_20_04
  elif [[ "$OS_VERSION" == "Ubuntu 22.04"* ]]; then
    sh bin/install/./ubuntu_22_04
  else
    echo "Unsupported Linux OS Version. Cannot install dependencies for $OS_VERSION."
  fi
else
  echo "Unsupported OS. Cannot install dependencies for $OSTYPE."
fi

# Installing public certificates
echo "ğŸšš Installing Renater certificates..."
sudo wget https://services.renater.fr/_media/tcs/geant_ov_rsa_ca_4_usertrust_rsa_certification_authority.pem -O /usr/local/share/ca-certificates/geant_ov_rsa_ca_4_usertrust_rsa_certification_authority.crt \
&& sudo wget https://services.renater.fr/_media/tcs/geant_ov_rsa_ca_4.pem -O /usr/local/share/ca-certificates/geant_ov_rsa_ca_4.crt \
&& sudo update-ca-certificates

# Install gems
echo "ğŸšš Installing gems..."
bundle install --jobs=4

# Install JS packages
echo "ğŸšš Installing JS packages..."
yarn install

# Copy .env if it doesn't exist
if [ ! -f .env ]; then
  echo "ğŸ› ï¸ Copying .env..."
  cp .env.dist .env
fi

# Copy database.yml if it doesn't exist
if [ ! -f config/database.yml ]; then
  echo "ğŸ› ï¸ Creating config/database.yml..."
  echo "# Generated by bin/setup" > config/database.yml
  echo "development: &development" >> config/database.yml
  echo "  adapter: postgis" >> config/database.yml
  echo "  encoding: unicode" >> config/database.yml
  echo "  database: ekylibre_development" >> config/database.yml
  echo "  pool: 10" >> config/database.yml
  echo "  postgis_extension: []" >> config/database.yml
  echo "  schema_search_path: public,postgis,lexicon" >> config/database.yml
  echo "  username: public,postgis,lexicon" >> config/database.yml
  echo "  password: ekylibre" >> config/database.yml
  echo "  host: 127.0.0.1" >> config/database.yml
  echo "test:" >> config/database.yml
  echo "  <<: *development" >> config/database.yml
  echo "  database: ekylibre_test<%= ENV['TEST_ENV_NUMBER'] %>" >> config/database.yml
fi

# Get database name from config/database.yml
DATABASE_NAME=$(ruby -ryaml -e "puts YAML.load_file('config/database.yml')['development']['database']")

# If postgresql database exists, migrate only DB schema else setup it.
if psql -lqt | cut -d \| -f 1 | grep -qw $DATABASE_NAME; then
  echo "âš™ï¸ Migrating database schema..."
  bin/rails db:migrate
else
  echo "âš™ï¸ Creating database..."
  bin/rails db:create db:migrate
fi

# Load lexicon
echo "âš™ï¸ Loading lexicon..."
bin/rails lexicon:load

if [ "$SKIP_DEMO" = true ] ; then
  echo "âš™ï¸ Skipping demo first run..."
  exit 0
else
  DEMO=${DEMO:-demo}
  # Prepare first run for development unless it already exists
  if [ -d db/first_runs/${DEMO} ]; then
    echo "âš™ï¸ First run for development already exists."
  else
    echo "âš™ï¸ Pull first run for development..."
    mkdir -p db/first_runs
    git clone git@github.com:ekylibre/first_run-demo.git db/first_runs/${DEMO}
  fi

  # Load demo first run unless schema is not present in database
  if psql -At -c 'SELECT nspname FROM pg_catalog.pg_namespace;' | grep -q ${DEMO}; then
    echo "âš™ï¸ Execute demo first run for development..."
    export TENANT=${DEMO}
    bin/rails first_run
    unset TENANT
    echo "âš™ï¸ Add ${DEMO}.ekylibre.lan to /etc/hosts..."
    echo "127.0.0.1 ${DEMO}.ekylibre.lan" | sudo tee --append /etc/host
  fi
fi

# Remove old logs and tempfiles
echo "âš™ï¸ Removing old logs and tempfiles..."
bin/rails log:clear tmp:clear

# Restart the application server
echo "âš™ï¸ Restarting application server..."
bin/rails restart
