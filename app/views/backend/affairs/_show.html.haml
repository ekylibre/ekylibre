- many_thirds = affair.deals.map(&:deal_third).uniq.count > 1
- if affair
  - affairs_controller = affair.class.name.tableize
  .affair
    .deals.active-list
      %table.list
        %thead
          %tr
            %th.act
              %i.icon.icon-unlink
            %th= affair.gap_class.human_attribute_name(:done_at)
            %th= affair.gap_class.human_attribute_name(:deal_type)
            - if many_thirds
              %th= affair.gap_class.human_attribute_name(:third)
            %th= affair.gap_class.human_attribute_name(:reference)
            %th= affair.gap_class.human_attribute_name(:amount)
        %tbody
          - affair.deals.sort_by{ |a| a.dealt_at || a.created_at }.each do |deal|
            %tr
              %td.act
                - if !current_deal || (deal != current_deal && deal.detachable?)
                  - if affair.gaps.none?
                    = link_to({action: :detach, controller: affairs_controller, id: deal.affair_id, :deal_type => deal.class.name.underscore, :deal_id => deal.id, redirect: request.fullpath}, method: :delete, data: {confirm: :are_you_sure.tl}, class: "unlink") do
                      %i
                      = :destroy.tl
                  - if deal.is_a? Gap
                    = link_to({action: :detach_gaps, controller: affairs_controller, id: deal.affair_id, redirect: request.fullpath}, method: :delete, data: {confirm: :are_you_sure.tl}, class: "remove") do
                      %i
                      = :destroy.tl
              %td.dat.dealt-on= deal.dealt_at.to_date.l
              %td.type= deal.class.model_name.human
              - if many_thirds
                %td.third= link_to(deal.deal_third.full_name, send("backend_#{deal.deal_third.class.name.underscore}_path", deal.deal_third))
              %td.name= link_to(deal.number, controller: "/backend/" + deal.class.name.tableize, action: :show, id: deal.id)
              %td.amount{class: (deal.good_deal? ? "debit" : "credit")}
                - amount = deal.deal_amount
                - amount *= -1 if deal.deal_credit?
                -# unless deal.deal_amount.zero?
                  %span.sign= deal.deal_debit? ? "+" : "-"
                %span.value= amount.l(currency: deal.currency)

    %table.list
      %tbody
        %tr.total
          - unless affair.closed?
            %th.txt
              - types.each_with_index do |type, index|
                - model = type.underscore
                - klass = type.classify.constantize
                = dropdown_menu_button "add_#{model}".to_sym, icon: false, class: (index.zero? ? 'primary' : nil), dropup: true do |l|
                  - excluded = affair.deals_of_type(klass).pluck(:id) + klass.where.not(currency: affair.currency).pluck(:id)
                  - existings = klass.where(klass.deal_third.name => affair.third).affairable.where.not(id: excluded)
                  - if existings.any?
                    - existings.each do |existing|
                      - l.item existing.label, { controller: affairs_controller, action: :attach, id: affair.id, deal_id: existing.id, deal_type: model, redirect: request.fullpath }, method: :post
                    - l.separator
                  - l.item :new.tl, { controller: model.pluralize, action: :new, klass.deal_third.foreign_key => affair.third.id, amount: affair.balance, redirect: request.fullpath, affair_id: affair.id }
              - if affair.finishable?
                .btn-group
                  = link_to("convert_balance_into_#{affair.losing? ? :loss : :profit}".tl, {controller: affairs_controller, action: :finish, id: affair.id, redirect: request.fullpath}, method: :post, class: "btn")
          %th= :balance.tl
          %td.total.amount.sum{class: (affair.balance.zero? ? "debit" : "credit")}
            = affair.balance.l(currency: affair.currency)
